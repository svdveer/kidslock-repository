<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #111; color: #e1e1e1; padding: 20px; font-family: sans-serif; }
        .card { background: #1c1c1c; border: 1px solid #333; border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        .day-box { background: #252525; border: 1px solid #444; border-radius: 10px; padding: 10px; text-align: center; }
        .day-box label { display: block; font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .day-box input { background: transparent; border: none; color: #03a9f4; text-align: center; font-weight: bold; width: 100%; font-size: 1.1rem; }
        .form-control-ha { background: #252525; border: 1px solid #444; color: #fff; }
    </style>
</head>
<body>
    <div class="container" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>⚙️ Instellingen</h2>
            <a href="./" class="btn btn-outline-light">Terug</a>
        </div>

        {% for tv in tvs %}
        {% set tv_loop = loop %}
        <div class="card">
            <div class="row align-items-center mb-4">
                <div class="col-md-5">
                    <input type="text" id="name_{{ tv_loop.index }}" class="form-control form-control-ha fs-4 fw-bold" value="{{ tv.name }}">
                    <small class="text-muted">{{ tv.ip }}</small>
                </div>
                <div class="col-md-4 text-center">
                    <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input" type="checkbox" id="unl_{{ tv_loop.index }}" {% if tv.no_limit %}checked{% endif %}>
                        <label class="ms-2">Onbeperkt</label>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <button class="btn btn-success w-100" onclick="save({{ tv_loop.index }}, '{{ tv.name }}')">Opslaan</button>
                    <button class="btn btn-link text-danger mt-2" onclick="del('{{ tv.name }}')">Verwijderen</button>
                </div>
            </div>

            <div class="row g-2">
                {% for day_name, day_key in [('Ma','mon'), ('Di','tue'), ('Wo','wed'), ('Do','thu'), ('Vr','fri'), ('Za','sat'), ('Zo','sun')] %}
                <div class="col">
                    <div class="day-box">
                        <label>{{ day_name }}</label>
                        <input type="number" id="{{ day_key }}_{{ tv_loop.index }}" value="{{ tv[day_key] }}">
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        
        <div class="card text-center py-5">
             <button class="btn btn-primary px-5" onclick="scan()" id="sBtn">Zoek Nieuwe TV's</button>
             <div id="results" class="mt-4"></div>
        </div>
    </div>

    <script>
        function save(idx, old) {
            const fd = new FormData();
            fd.append('old_name', old);
            fd.append('new_name', document.getElementById('name_'+idx).value);
            fd.append('no_limit', document.getElementById('unl_'+idx).checked ? 1 : 0);
            ['mon','tue','wed','thu','fri','sat','sun'].forEach(d => {
                fd.append(d, document.getElementById(d+'_'+idx).value);
            });
            fetch('./api/update_tv', {method:'POST', body:fd}).then(() => location.reload());
        }
        function del(n) { if(confirm('Wissen?')) fetch('./api/delete_tv/'+n, {method:'POST'}).then(() => location.reload()); }
        function scan() {
            const b = document.getElementById('sBtn'); b.disabled = true; b.innerText = "Bezig...";
            fetch('./api/discover').then(r => r.json()).then(data => {
                let h = "";
                data.forEach(d => {
                    h += `<div class="p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
                        <span>${d.name} (${d.ip})</span>
                        <button class="btn btn-sm btn-success" onclick="pair('${d.ip}')">Koppel</button>
                    </div>`;
                });
                document.getElementById('results').innerHTML = h || "Geen TV's gevonden.";
            }).finally(() => { b.disabled = false; b.innerText = "Zoek Nieuwe TV's"; });
        }
        function pair(ip) {
            const code = prompt("Voer de koppelcode in van de TV:");
            if(!code) return;
            const fd = new FormData(); fd.append('ip', ip); fd.append('code', code);
            fetch('./api/pair_with_device', {method:'POST', body:fd}).then(r => r.json()).then(res => {
                if(res.status==='success') location.reload(); else alert('Fout!');
            });
        }
    </script>
</body>
</html>