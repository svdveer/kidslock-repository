<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <style> body { background: #f8f9fa; padding: 20px; } .card { border-radius: 15px; } </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">KidsLock Setup</h2>

        <div class="card p-4 shadow-sm mb-4 border-primary">
            <h4>üîç Zoek TV's</h4>
            <p class="text-muted">Open de app op de TV en klik hieronder op scan.</p>
            <button class="btn btn-primary w-100" onclick="scan()" id="sBtn">Scan Netwerk</button>
            <div id="results" class="mt-3"></div>
        </div>

        <div class="card p-4 shadow-sm">
            <h4>üì∫ Gekoppelde Apparaten</h4>
            <div id="tv_list">
                {% for tv in tvs %}
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <span><strong>{{ tv.name }}</strong> ({{ tv.ip }})</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="del('{{ tv.name }}')">Verwijder</button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        function scan() {
            const b = document.getElementById('sBtn'); b.disabled = true; b.innerText = "Bezig...";
            fetch('./api/discover').then(r => r.json()).then(data => {
                let h = "";
                data.forEach(d => {
                    h += `<div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>${d.name} (${d.ip})</span>
                        <div class="d-flex gap-2">
                            <input type="text" id="c_${d.ip.replace(/\./g,'_')}" class="form-control form-control-sm" placeholder="Code" style="width:80px;">
                            <button class="btn btn-sm btn-success" onclick="pair('${d.ip}')">Koppel</button>
                        </div>
                    </div>`;
                });
                document.getElementById('results').innerHTML = h || "Geen TV's gevonden.";
            }).finally(() => { b.disabled = false; b.innerText = "Scan Netwerk"; });
        }

        function pair(ip) {
            const c = document.getElementById('c_' + ip.replace(/\./g,'_')).value;
            const fd = new FormData(); fd.append('ip', ip); fd.append('code', c);
            fetch('./api/pair_with_device', {method:'POST', body:fd}).then(r => r.json()).then(res => {
                if(res.status==='success') { alert('Gelukt!'); location.reload(); } else { alert('Fout!'); }
            });
        }

        function del(n) { if(confirm('Verwijderen?')) fetch('./api/delete_tv/'+n, {method:'POST'}).then(() => location.reload()); }
    </script>
</body>
</html>